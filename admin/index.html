<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Site Manager</title>
  </head>
  <body>
    <!--
      Admin entry using Netlify Identity + Git Gateway (git-gateway backend)
      - Ensure Netlify Identity is enabled for the site in Netlify dashboard.
      - Enable "Git Gateway" under Identity -> Services so the CMS can commit via Git Gateway.
      - This page initializes Netlify Identity and opens the login modal if an invite token is present.
    -->

    <!-- Netlify Identity widget (required for Git Gateway) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
      // Initialize Netlify Identity so invite_token in the URL hash is consumed.
      // If an invite token is present, open the Identity modal to complete onboarding.
      (function () {
        try {
          if (window.netlifyIdentity) {
            window.netlifyIdentity.init();

            window.netlifyIdentity.on('init', function (user) {
              try {
                var hash = window.location.hash || "";
                if (!user && hash.indexOf('invite_token=') !== -1) {
                  window.netlifyIdentity.open();
                }
              } catch (e) {
                console && console.warn && console.warn('Identity init handler error', e);
              }
            });

            // When a user logs in via the widget, refresh the page so the CMS picks up the session.
            window.netlifyIdentity.on('login', function() {
              setTimeout(function(){ window.location.reload(); }, 10);
            });
          } else {
            console && console.warn && console.warn('netlifyIdentity not available');
          }
        } catch (e) {
          console && console.warn && console.warn('Netlify Identity init failed', e);
        }
      })();
    </script>

    <!-- Decap / Netlify CMS (must be loaded after Identity widget) -->
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
 
    <noscript>
      <p>Netlify CMS requires JavaScript. Please enable JavaScript to use the CMS.</p>
    </noscript>

    <script>
      // Register site styles and a small override for previews to prevent oversized hero images.
      (function () {
        function registerStyles() {
          try {
            if (window.CMS && typeof window.CMS.registerPreviewStyle === "function") {
              // Load the site's main stylesheet inside the preview iframe
              window.CMS.registerPreviewStyle("/assets/css/styles.css");
              // Add a raw override to cap hero image heights in previews
              window.CMS.registerPreviewStyle(
                ".article-hero img { max-height: 360px !important; height: auto !important; width: auto !important; display:block; margin: 1rem auto !important; }",
                { raw: true }
              );

              // Target any auto-generated preview container classes (wildcard) and common widget preview classes
              // This avoids relying on generated classnames and ensures images inside preview widgets are constrained.
              window.CMS.registerPreviewStyle(
                "[class*=\"WidgetPreviewContainer\"] img, [class*=\"WidgetPreview\"] img, .WidgetPreviewContainer img, .nc-widgetPreview img { max-width: 100% !important; height: auto !important; max-height: 360px !important; display:block !important; margin: 0.5rem auto !important; object-fit: cover !important; } \
                 [class*=\"WidgetPreviewContainer\"], [class*=\"WidgetPreview\"], .WidgetPreviewContainer, .nc-widgetPreview { overflow: hidden !important; max-width: 100% !important; }",
                { raw: true }
              );

              console && console.info && console.info("Netlify CMS preview styles registered.");
              return true;
            }
          } catch (e) {
            console && console.warn && console.warn("registerPreviewStyle error", e);
          }
          return false;
        }
 
        // Try immediately, otherwise retry a few times while CMS initializes
        if (!registerStyles()) {
          var attempts = 0;
          var t = setInterval(function () {
            attempts++;
            if (registerStyles() || attempts > 20) clearInterval(t);
          }, 250);
        }
      })();
    </script>
 
    <script>
      // Sync the top "Published" indicator with the frontmatter `published` boolean.
      // This watches for the editor's published checkbox and keeps the header button in sync.
      (function () {
        function findPublishedFieldCheckbox() {
          try {
            // Netlify CMS renders fields; find by label text first
            var labels = Array.from(document.querySelectorAll('.nc-controlPane label, label'));
            for (var i = 0; i < labels.length; i++) {
              var txt = (labels[i].textContent || '').trim().toLowerCase();
              if (txt === 'published' || txt.indexOf('published') !== -1) {
                var input = labels[i].querySelector('input[type="checkbox"], input[type="radio"], input');
                if (input) return input;
                var forId = labels[i].getAttribute('for');
                if (forId) {
                  var el = document.getElementById(forId);
                  if (el) return el;
                }
              }
            }
            // fallback: search inputs with name containing "published"
            var fallback = document.querySelector('input[name*="published"], input[id*="published"]');
            return fallback;
          } catch (e) {
            console && console.warn && console.warn('findPublishedFieldCheckbox error', e);
            return null;
          }
        }
 
        function findHeaderPublishButton() {
          try {
            // The CMS header uses buttons; find the one that mentions publish/published
            var header = document.querySelector('.nc-root, #nc-root, body');
            var buttons = header ? Array.from(header.querySelectorAll('button')) : Array.from(document.querySelectorAll('button'));
            for (var i = 0; i < buttons.length; i++) {
              var t = (buttons[i].textContent || '').trim().toLowerCase();
              if (/^(publish|published|unpublish|save|save & publish)/i.test(t) || t.indexOf('publish') !== -1) {
                // Heuristic: prefer buttons inside the header/top controls
                if (buttons[i].closest('.nc-entryToolbar') || buttons[i].closest('.nc-app') || buttons[i].closest('.nc-root')) {
                  return buttons[i];
                }
                // fallback to first matching
                return buttons[i];
              }
            }
          } catch (e) {
            console && console.warn && console.warn('findHeaderPublishButton error', e);
          }
          return null;
        }
 
        function updateHeaderButton(btn, checked) {
          if (!btn) return;
          try {
            btn.textContent = checked ? 'Published' : 'Unpublished';
            btn.setAttribute('data-published', checked ? 'true' : 'false');
          } catch (e) {}
        }
 
        function wireUp(checkbox, btn) {
          try {
            // initialize
            updateHeaderButton(btn, !!checkbox.checked);
 
            // when the checkbox changes, update header
            checkbox.addEventListener('change', function () {
              updateHeaderButton(btn, !!checkbox.checked);
            });
 
            // clicking header button toggles the checkbox (so users can use it)
            btn.addEventListener('click', function (ev) {
              try {
                ev.preventDefault();
                ev.stopPropagation();
                checkbox.checked = !checkbox.checked;
                var evt = new Event('change', { bubbles: true });
                checkbox.dispatchEvent(evt);
                updateHeaderButton(btn, !!checkbox.checked);
              } catch (e) {
                console && console.warn && console.warn('header button toggle error', e);
              }
            }, { passive: false });
          } catch (e) {
            console && console.warn && console.warn('wireUp error', e);
          }
        }
 
        // Poll for editor UI readiness
        var tries = 0;
        var interval = setInterval(function () {
          tries++;
          var checkbox = findPublishedFieldCheckbox();
          var btn = findHeaderPublishButton();
          if (checkbox && btn) {
            clearInterval(interval);
            wireUp(checkbox, btn);
          } else if (tries > 60) {
            clearInterval(interval);
            console && console.warn && console.warn('Could not find CMS publish widgets to wire up.');
          }
        }, 300);
      })();
    </script>

    <script>
      // Remove the CMS "Published" dropdown UI and inject a simple Delete button in the entry header.
      // This is a DOM-based enhancement (non-invasive) that tries to be resilient across CMS versions.
      (function () {
        function hidePublishControls() {
          try {
            var root = document.querySelector('.nc-root, #nc-root, body');
            if (!root) return false;
            // Find nodes that look like publish controls by text content
            var candidates = Array.from(root.querySelectorAll('button, a, span, div'));
            candidates.forEach(function (el) {
              var txt = (el.textContent || '').trim().toLowerCase();
              if (!txt) return;
              // hide any control that is explicitly about publish/duplicate/status dropdowns
              if (txt === 'published' || txt === 'unpublished' || txt.indexOf('publish') !== -1 || txt.indexOf('duplicate') !== -1 || txt.indexOf('status') !== -1) {
                var container = el.closest('.nc-entryToolbar') || el.closest('.nc-app') || el.closest('.nc-root') || el.parentElement;
                if (container) container.style.display = 'none';
              }
            });
            return true;
          } catch (e) {
            console && console.warn && console.warn('hidePublishControls error', e);
            return false;
          }
        }

        function addDeleteButton() {
          try {
            // Already added?
            if (document.getElementById('plausible-delete-article-btn')) return true;

            // Find header toolbar container to attach our button
            var attachTo = document.querySelector('.nc-entryToolbar') || document.querySelector('.nc-app') || document.querySelector('.nc-root') || document.body;
            if (!attachTo) return false;

            var btn = document.createElement('button');
            btn.id = 'plausible-delete-article-btn';
            btn.textContent = 'Delete Article';
            btn.title = 'Permanently delete this article from the repository';
            btn.style.cssText = 'margin-left:8px;background:#b11;color:#fff;border:none;padding:.4rem .75rem;border-radius:6px;cursor:pointer;font-weight:700;';

            btn.addEventListener('click', function (ev) {
              ev.preventDefault();
              ev.stopPropagation();
              if (!confirm('Delete this article file from the repository? This is permanent.')) return;

              // Attempt to find and click the CMS delete UI element
              var all = Array.from(document.querySelectorAll('button, a, div, span'));
              // Exact-match "Delete" or "Delete entry"
              var del = all.find(function (e) {
                var t = (e.textContent || '').trim().toLowerCase();
                return t === 'delete' || t === 'delete entry' || t === 'delete article';
              });
              if (del) {
                del.click();
                return;
              }

              // If not found, try opening the actions/menu button then click Delete inside it
              var actions = all.find(function (e) {
                var t = (e.textContent || '').trim().toLowerCase();
                var aria = e.getAttribute && e.getAttribute('aria-label');
                return (t.indexOf('actions') !== -1) || (aria && aria.toLowerCase().indexOf('actions') !== -1) || (t.indexOf('entry') !== -1 && t.indexOf('menu') !== -1);
              });
              if (actions) {
                actions.click();
                // Wait a bit for menu to appear, then find delete
                setTimeout(function () {
                  var menuItems = Array.from(document.querySelectorAll('button, a, div, span'));
                  var del2 = menuItems.find(function (e) {
                    var t = (e.textContent || '').trim().toLowerCase();
                    return t === 'delete' || t === 'delete entry' || t === 'delete article';
                  });
                  if (del2) {
                    del2.click();
                  } else {
                    alert('Delete option not found in actions menu. Please use the CMS UI menu to delete the entry.');
                  }
                }, 350);
                return;
              }

              alert('Could not find a Delete control in the CMS UI. Please open the entry actions menu and delete manually.');
            }, { passive: false });

            // Append to toolbar (prefer right side)
            attachTo.appendChild(btn);
            return true;
          } catch (e) {
            console && console.warn && console.warn('addDeleteButton error', e);
            return false;
          }
        }

        // Poll to apply changes once CMS UI is ready
        var attempts = 0;
        var t = setInterval(function () {
          attempts++;
          hidePublishControls();
          addDeleteButton();
          if (attempts > 60) clearInterval(t);
        }, 300);
      })();
    </script>
  </body>
</html>